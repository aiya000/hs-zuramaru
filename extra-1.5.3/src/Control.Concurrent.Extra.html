<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP, TupleSections #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-duplicate-exports #-}</span><span>
</span><a name="line-3"></a><span>
</span><a name="line-4"></a><span class="hs-comment">-- | Extra functions for &quot;Control.Concurrent&quot;.</span><span>
</span><a name="line-5"></a><span class="hs-comment">--</span><span>
</span><a name="line-6"></a><span class="hs-comment">--   This module includes three new types of 'MVar', namely 'Lock' (no associated value),</span><span>
</span><a name="line-7"></a><span class="hs-comment">--   'Var' (never empty) and 'Barrier' (filled at most once). See</span><span>
</span><a name="line-8"></a><span class="hs-comment">--   &lt;http://neilmitchell.blogspot.co.uk/2012/06/flavours-of-mvar_04.html this blog post&gt;</span><span>
</span><a name="line-9"></a><span class="hs-comment">--   for examples and justification.</span><span>
</span><a name="line-10"></a><span class="hs-comment">--</span><span>
</span><a name="line-11"></a><span class="hs-comment">--   If you need greater control of exceptions and threads</span><span>
</span><a name="line-12"></a><span class="hs-comment">--   see the &lt;http://hackage.haskell.org/package/slave-thread slave-thread&gt; package.</span><span>
</span><a name="line-13"></a><span class="hs-comment">--   If you need elaborate relationships between threads</span><span>
</span><a name="line-14"></a><span class="hs-comment">--   see the &lt;http://hackage.haskell.org/package/async async&gt; package.</span><span>
</span><a name="line-15"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span class="hs-operator">.</span><span class="hs-identifier">Extra</span><span class="hs-special">(</span><span>
</span><a name="line-16"></a><span>    </span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>    </span><span class="hs-identifier hs-var">getNumCapabilities</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">setNumCapabilities</span><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.Extra.html#withNumCapabilities"><span class="hs-identifier hs-var">withNumCapabilities</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>    </span><span class="hs-identifier hs-var">forkFinally</span><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.Extra.html#once"><span class="hs-identifier hs-var">once</span></a><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.Extra.html#onceFork"><span class="hs-identifier hs-var">onceFork</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>    </span><span class="hs-comment">-- * Lock</span><span>
</span><a name="line-20"></a><span>    </span><a href="Control.Concurrent.Extra.html#Lock"><span class="hs-identifier hs-type">Lock</span></a><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.Extra.html#newLock"><span class="hs-identifier hs-var">newLock</span></a><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.Extra.html#withLock"><span class="hs-identifier hs-var">withLock</span></a><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.Extra.html#withLockTry"><span class="hs-identifier hs-var">withLockTry</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>    </span><span class="hs-comment">-- * Var</span><span>
</span><a name="line-22"></a><span>    </span><a href="Control.Concurrent.Extra.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.Extra.html#newVar"><span class="hs-identifier hs-var">newVar</span></a><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.Extra.html#readVar"><span class="hs-identifier hs-var">readVar</span></a><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.Extra.html#writeVar"><span class="hs-identifier hs-var">writeVar</span></a><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.Extra.html#modifyVar"><span class="hs-identifier hs-var">modifyVar</span></a><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.Extra.html#modifyVar_"><span class="hs-identifier hs-var">modifyVar_</span></a><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.Extra.html#withVar"><span class="hs-identifier hs-var">withVar</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>    </span><span class="hs-comment">-- * Barrier</span><span>
</span><a name="line-24"></a><span>    </span><a href="Control.Concurrent.Extra.html#Barrier"><span class="hs-identifier hs-type">Barrier</span></a><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.Extra.html#newBarrier"><span class="hs-identifier hs-var">newBarrier</span></a><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.Extra.html#signalBarrier"><span class="hs-identifier hs-var">signalBarrier</span></a><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.Extra.html#waitBarrier"><span class="hs-identifier hs-var">waitBarrier</span></a><span class="hs-special">,</span><span> </span><a href="Control.Concurrent.Extra.html#waitBarrierMaybe"><span class="hs-identifier hs-var">waitBarrierMaybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="Control.Exception.Extra.html"><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Exception</span><span class="hs-operator">.</span><span class="hs-identifier">Extra</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="Control.Monad.Extra.html"><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Extra</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Either.Extra.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Either</span><span class="hs-operator">.</span><span class="hs-identifier">Extra</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Functor</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Prelude</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span class="hs-comment">-- | On GHC 7.6 and above with the @-threaded@ flag, brackets a call to 'setNumCapabilities'.</span><span>
</span><a name="line-37"></a><span class="hs-comment">--   On lower versions (which lack 'setNumCapabilities') this function just runs the argument action.</span><span>
</span><a name="line-38"></a><span class="hs-identifier">withNumCapabilities</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679058082"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679058082"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-39"></a><a name="withNumCapabilities"><a href="Control.Concurrent.Extra.html#withNumCapabilities"><span class="hs-identifier">withNumCapabilities</span></a></a><span> </span><a name="local-6989586621679058083"><a href="#local-6989586621679058083"><span class="hs-identifier">new</span></a></a><span> </span><a name="local-6989586621679058084"><a href="#local-6989586621679058084"><span class="hs-identifier">act</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">rtsSupportsBoundThreads</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-40"></a><span>    </span><a name="local-6989586621679058085"><a href="#local-6989586621679058085"><span class="hs-identifier">old</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getNumCapabilities</span><span>
</span><a name="line-41"></a><span>    </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679058085"><span class="hs-identifier hs-var">old</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679058083"><span class="hs-identifier hs-var">new</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679058084"><span class="hs-identifier hs-var">act</span></a><span> </span><span class="hs-keyword">else</span><span>
</span><a name="line-42"></a><span>        </span><span class="hs-identifier hs-var">bracket_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">setNumCapabilities</span><span> </span><a href="#local-6989586621679058083"><span class="hs-identifier hs-var">new</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">setNumCapabilities</span><span> </span><a href="#local-6989586621679058085"><span class="hs-identifier hs-var">old</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679058084"><span class="hs-identifier hs-var">act</span></a><span>
</span><a name="line-43"></a><span class="hs-identifier">withNumCapabilities</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679058086"><a href="#local-6989586621679058086"><span class="hs-identifier">act</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679058086"><span class="hs-identifier hs-var">act</span></a><span>
</span><a name="line-44"></a><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span class="hs-cpp">#if __GLASGOW_HASKELL__ &lt; 702</span><span>
</span><a name="line-47"></a><span class="hs-comment">-- | A version of 'getNumCapabilities' that works on all versions of GHC, but returns 1 before GHC 7.2.</span><span>
</span><a name="line-48"></a><span class="hs-identifier">getNumCapabilities</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">Int</span><span>
</span><a name="line-49"></a><span class="hs-identifier">getNumCapabilities</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-50"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span class="hs-cpp">#if __GLASGOW_HASKELL__ &lt; 706</span><span>
</span><a name="line-53"></a><span class="hs-comment">-- | A version of 'setNumCapabilities' that works on all versions of GHC, but has no effect before GHC 7.6.</span><span>
</span><a name="line-54"></a><span class="hs-identifier">setNumCapabilities</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span class="hs-identifier">setNumCapabilities</span><span> </span><span class="hs-identifier">n</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span>
</span><a name="line-59"></a><span class="hs-cpp">#if __GLASGOW_HASKELL__ &lt; 706</span><span>
</span><a name="line-60"></a><span class="hs-comment">-- | fork a thread and call the supplied function when the thread is about</span><span>
</span><a name="line-61"></a><span class="hs-comment">-- to terminate, with an exception or a returned value.  The function is</span><span>
</span><a name="line-62"></a><span class="hs-comment">-- called with asynchronous exceptions masked.</span><span>
</span><a name="line-63"></a><span class="hs-comment">--</span><span>
</span><a name="line-64"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-65"></a><span class="hs-comment">-- forkFinally action and_then =</span><span>
</span><a name="line-66"></a><span class="hs-comment">--    mask $ \restore -&gt;</span><span>
</span><a name="line-67"></a><span class="hs-comment">--      forkIO $ try (restore action) &gt;&gt;= and_then</span><span>
</span><a name="line-68"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-69"></a><span class="hs-comment">--</span><span>
</span><a name="line-70"></a><span class="hs-comment">-- This function is useful for informing the parent when a child</span><span>
</span><a name="line-71"></a><span class="hs-comment">-- terminates, for example.</span><span>
</span><a name="line-72"></a><span class="hs-identifier">forkFinally</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Either</span><span> </span><span class="hs-identifier">SomeException</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">ThreadId</span><span>
</span><a name="line-73"></a><span class="hs-identifier">forkFinally</span><span> </span><span class="hs-identifier">action</span><span> </span><span class="hs-identifier">and_then</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-74"></a><span>  </span><span class="hs-identifier">mask</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">restore</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-75"></a><span>    </span><span class="hs-identifier">forkIO</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">try</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">restore</span><span> </span><span class="hs-identifier">action</span><span class="hs-special">)</span><span> </span><span class="hs-operator">&gt;&gt;=</span><span> </span><span class="hs-identifier">and_then</span><span>
</span><a name="line-76"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span>
</span><a name="line-79"></a><span class="hs-comment">-- | Given an action, produce a wrapped action that runs at most once.</span><span>
</span><a name="line-80"></a><span class="hs-comment">--   If the function raises an exception, the same exception will be reraised each time.</span><span>
</span><a name="line-81"></a><span class="hs-comment">--</span><span>
</span><a name="line-82"></a><span class="hs-comment">-- &gt; let x ||| y = do t1 &lt;- onceFork x; t2 &lt;- onceFork y; t1; t2</span><span>
</span><a name="line-83"></a><span class="hs-comment">-- &gt; \(x :: IO Int) -&gt; void (once x) == return ()</span><span>
</span><a name="line-84"></a><span class="hs-comment">-- &gt; \(x :: IO Int) -&gt; join (once x) == x</span><span>
</span><a name="line-85"></a><span class="hs-comment">-- &gt; \(x :: IO Int) -&gt; (do y &lt;- once x; y; y) == x</span><span>
</span><a name="line-86"></a><span class="hs-comment">-- &gt; \(x :: IO Int) -&gt; (do y &lt;- once x; y ||| y) == x</span><span>
</span><a name="line-87"></a><span class="hs-identifier">once</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679058081"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679058081"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-88"></a><a name="once"><a href="Control.Concurrent.Extra.html#once"><span class="hs-identifier">once</span></a></a><span> </span><a name="local-6989586621679058087"><a href="#local-6989586621679058087"><span class="hs-identifier">act</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-89"></a><span>    </span><a name="local-6989586621679058088"><a href="#local-6989586621679058088"><span class="hs-identifier">var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Control.Concurrent.Extra.html#newVar"><span class="hs-identifier hs-var">newVar</span></a><span> </span><a href="Control.Concurrent.Extra.html#OncePending"><span class="hs-identifier hs-var">OncePending</span></a><span>
</span><a name="line-90"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679058089"><a href="#local-6989586621679058089"><span class="hs-identifier">run</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">either</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span> </span><span class="hs-identifier hs-var">return</span><span>
</span><a name="line-91"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mask</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679058090"><a href="#local-6989586621679058090"><span class="hs-identifier">unmask</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">join</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Control.Concurrent.Extra.html#modifyVar"><span class="hs-identifier hs-var">modifyVar</span></a><span> </span><a href="#local-6989586621679058088"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679058091"><a href="#local-6989586621679058091"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679058091"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-92"></a><span>        </span><a href="Control.Concurrent.Extra.html#OnceDone"><span class="hs-identifier hs-var">OnceDone</span></a><span> </span><a name="local-6989586621679058092"><a href="#local-6989586621679058092"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679058091"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679058090"><span class="hs-identifier hs-var">unmask</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679058089"><span class="hs-identifier hs-var">run</span></a><span> </span><a href="#local-6989586621679058092"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-93"></a><span>        </span><a href="Control.Concurrent.Extra.html#OnceRunning"><span class="hs-identifier hs-var">OnceRunning</span></a><span> </span><a name="local-6989586621679058093"><a href="#local-6989586621679058093"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679058091"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679058090"><span class="hs-identifier hs-var">unmask</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679058089"><span class="hs-identifier hs-var">run</span></a><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="Control.Concurrent.Extra.html#waitBarrier"><span class="hs-identifier hs-var">waitBarrier</span></a><span> </span><a href="#local-6989586621679058093"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-94"></a><span>        </span><a href="Control.Concurrent.Extra.html#OncePending"><span class="hs-identifier hs-var">OncePending</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-95"></a><span>            </span><a name="local-6989586621679058094"><a href="#local-6989586621679058094"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Control.Concurrent.Extra.html#newBarrier"><span class="hs-identifier hs-var">newBarrier</span></a><span>
</span><a name="line-96"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><a href="Control.Concurrent.Extra.html#OnceRunning"><span class="hs-identifier hs-var">OnceRunning</span></a><span> </span><a href="#local-6989586621679058094"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-97"></a><span>                </span><a name="local-6989586621679058095"><a href="#local-6989586621679058095"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Control.Exception.Extra.html#try_"><span class="hs-identifier hs-var">try_</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679058090"><span class="hs-identifier hs-var">unmask</span></a><span> </span><a href="#local-6989586621679058087"><span class="hs-identifier hs-var">act</span></a><span>
</span><a name="line-98"></a><span>                </span><a href="Control.Concurrent.Extra.html#signalBarrier"><span class="hs-identifier hs-var">signalBarrier</span></a><span> </span><a href="#local-6989586621679058094"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621679058095"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-99"></a><span>                </span><a href="Control.Concurrent.Extra.html#modifyVar_"><span class="hs-identifier hs-var">modifyVar_</span></a><span> </span><a href="#local-6989586621679058088"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Control.Concurrent.Extra.html#OnceDone"><span class="hs-identifier hs-var">OnceDone</span></a><span> </span><a href="#local-6989586621679058095"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-100"></a><span>                </span><a href="#local-6989586621679058089"><span class="hs-identifier hs-var">run</span></a><span> </span><a href="#local-6989586621679058095"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span class="hs-keyword">data</span><span> </span><a name="Once"><a href="Control.Concurrent.Extra.html#Once"><span class="hs-identifier">Once</span></a></a><span> </span><a name="local-6989586621679058065"><a href="#local-6989586621679058065"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="OncePending"><a href="Control.Concurrent.Extra.html#OncePending"><span class="hs-identifier">OncePending</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="OnceRunning"><a href="Control.Concurrent.Extra.html#OnceRunning"><span class="hs-identifier">OnceRunning</span></a></a><span> </span><span class="hs-special">(</span><a href="Control.Concurrent.Extra.html#Barrier"><span class="hs-identifier hs-type">Barrier</span></a><span> </span><a href="#local-6989586621679058065"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="OnceDone"><a href="Control.Concurrent.Extra.html#OnceDone"><span class="hs-identifier">OnceDone</span></a></a><span> </span><a href="#local-6989586621679058065"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-103"></a><span>
</span><a name="line-104"></a><span>
</span><a name="line-105"></a><span class="hs-comment">-- | Like 'once', but immediately starts running the computation on a background thread.</span><span>
</span><a name="line-106"></a><span class="hs-comment">--</span><span>
</span><a name="line-107"></a><span class="hs-comment">-- &gt; \(x :: IO Int) -&gt; join (onceFork x) == x</span><span>
</span><a name="line-108"></a><span class="hs-comment">-- &gt; \(x :: IO Int) -&gt; (do a &lt;- onceFork x; a; a) == x</span><span>
</span><a name="line-109"></a><span class="hs-identifier">onceFork</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679058080"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679058080"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-110"></a><a name="onceFork"><a href="Control.Concurrent.Extra.html#onceFork"><span class="hs-identifier">onceFork</span></a></a><span> </span><a name="local-6989586621679058096"><a href="#local-6989586621679058096"><span class="hs-identifier">act</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-111"></a><span>    </span><a name="local-6989586621679058097"><a href="#local-6989586621679058097"><span class="hs-identifier">bar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Control.Concurrent.Extra.html#newBarrier"><span class="hs-identifier hs-var">newBarrier</span></a><span>
</span><a name="line-112"></a><span>    </span><span class="hs-identifier hs-var">forkFinally</span><span> </span><a href="#local-6989586621679058096"><span class="hs-identifier hs-var">act</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Control.Concurrent.Extra.html#signalBarrier"><span class="hs-identifier hs-var">signalBarrier</span></a><span> </span><a href="#local-6989586621679058097"><span class="hs-identifier hs-var">bar</span></a><span>
</span><a name="line-113"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">either</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="Control.Concurrent.Extra.html#waitBarrier"><span class="hs-identifier hs-var">waitBarrier</span></a><span> </span><a href="#local-6989586621679058097"><span class="hs-identifier hs-var">bar</span></a><span>
</span><a name="line-114"></a><span>
</span><a name="line-115"></a><span>
</span><a name="line-116"></a><span class="hs-comment">---------------------------------------------------------------------</span><span>
</span><a name="line-117"></a><span class="hs-comment">-- LOCK</span><span>
</span><a name="line-118"></a><span>
</span><a name="line-119"></a><span class="hs-comment">-- | Like an MVar, but has no value.</span><span>
</span><a name="line-120"></a><span class="hs-comment">--   Used to guarantees single-threaded access, typically to some system resource. </span><span>
</span><a name="line-121"></a><span class="hs-comment">--   As an example:</span><span>
</span><a name="line-122"></a><span class="hs-comment">--</span><span>
</span><a name="line-123"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-124"></a><span class="hs-comment">-- lock &lt;- 'newLock'</span><span>
</span><a name="line-125"></a><span class="hs-comment">-- let output = 'withLock' . putStrLn</span><span>
</span><a name="line-126"></a><span class="hs-comment">-- forkIO $ do ...; output \&quot;hello\&quot;</span><span>
</span><a name="line-127"></a><span class="hs-comment">-- forkIO $ do ...; output \&quot;world\&quot;</span><span>
</span><a name="line-128"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-129"></a><span class="hs-comment">--</span><span>
</span><a name="line-130"></a><span class="hs-comment">--   Here we are creating a lock to ensure that when writing output our messages</span><span>
</span><a name="line-131"></a><span class="hs-comment">--   do not get interleaved. This use of MVar never blocks on a put. It is permissible,</span><span>
</span><a name="line-132"></a><span class="hs-comment">--   but rare, that a withLock contains a withLock inside it - but if so,</span><span>
</span><a name="line-133"></a><span class="hs-comment">--   watch out for deadlocks.</span><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span class="hs-keyword">newtype</span><span> </span><a name="Lock"><a href="Control.Concurrent.Extra.html#Lock"><span class="hs-identifier">Lock</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Lock"><a href="Control.Concurrent.Extra.html#Lock"><span class="hs-identifier">Lock</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MVar</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-136"></a><span>
</span><a name="line-137"></a><span class="hs-comment">-- | Create a new 'Lock'.</span><span>
</span><a name="line-138"></a><span class="hs-identifier">newLock</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Control.Concurrent.Extra.html#Lock"><span class="hs-identifier hs-type">Lock</span></a><span>
</span><a name="line-139"></a><a name="newLock"><a href="Control.Concurrent.Extra.html#newLock"><span class="hs-identifier">newLock</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Control.Concurrent.Extra.html#Lock"><span class="hs-identifier hs-var">Lock</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">newMVar</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-140"></a><span>
</span><a name="line-141"></a><span class="hs-comment">-- | Perform some operation while holding 'Lock'. Will prevent all other</span><span>
</span><a name="line-142"></a><span class="hs-comment">--   operations from using the 'Lock' while the action is ongoing.</span><span>
</span><a name="line-143"></a><span class="hs-identifier">withLock</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Control.Concurrent.Extra.html#Lock"><span class="hs-identifier hs-type">Lock</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679058079"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679058079"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-144"></a><a name="withLock"><a href="Control.Concurrent.Extra.html#withLock"><span class="hs-identifier">withLock</span></a></a><span> </span><span class="hs-special">(</span><a href="Control.Concurrent.Extra.html#Lock"><span class="hs-identifier hs-var">Lock</span></a><span> </span><a name="local-6989586621679058098"><a href="#local-6989586621679058098"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withMVar</span><span> </span><a href="#local-6989586621679058098"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">const</span><span>
</span><a name="line-145"></a><span>
</span><a name="line-146"></a><span class="hs-comment">-- | Like 'withLock' but will never block. If the operation cannot be executed</span><span>
</span><a name="line-147"></a><span class="hs-comment">--   immediately it will return 'Nothing'.</span><span>
</span><a name="line-148"></a><span class="hs-identifier">withLockTry</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Control.Concurrent.Extra.html#Lock"><span class="hs-identifier hs-type">Lock</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679058078"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679058078"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-149"></a><a name="withLockTry"><a href="Control.Concurrent.Extra.html#withLockTry"><span class="hs-identifier">withLockTry</span></a></a><span> </span><span class="hs-special">(</span><a href="Control.Concurrent.Extra.html#Lock"><span class="hs-identifier hs-var">Lock</span></a><span> </span><a name="local-6989586621679058120"><a href="#local-6989586621679058120"><span class="hs-identifier">m</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679058121"><a href="#local-6989586621679058121"><span class="hs-identifier">act</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bracket</span><span>
</span><a name="line-150"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tryTakeMVar</span><span> </span><a href="#local-6989586621679058120"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-151"></a><span>    </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679058122"><a href="#local-6989586621679058122"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isJust</span><span> </span><a href="#local-6989586621679058122"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">putMVar</span><span> </span><a href="#local-6989586621679058120"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-152"></a><span>    </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679058123"><a href="#local-6989586621679058123"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><a href="#local-6989586621679058123"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679058121"><span class="hs-identifier hs-var">act</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-153"></a><span>
</span><a name="line-154"></a><span>
</span><a name="line-155"></a><span class="hs-comment">---------------------------------------------------------------------</span><span>
</span><a name="line-156"></a><span class="hs-comment">-- VAR</span><span>
</span><a name="line-157"></a><span>
</span><a name="line-158"></a><span class="hs-comment">-- | Like an MVar, but must always be full.</span><span>
</span><a name="line-159"></a><span class="hs-comment">--   Used to on a mutable variable in a thread-safe way.</span><span>
</span><a name="line-160"></a><span class="hs-comment">--   As an example:</span><span>
</span><a name="line-161"></a><span class="hs-comment">--</span><span>
</span><a name="line-162"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-163"></a><span class="hs-comment">-- hits &lt;- 'newVar' 0</span><span>
</span><a name="line-164"></a><span class="hs-comment">-- forkIO $ do ...; 'modifyVar_' hits (+1); ...</span><span>
</span><a name="line-165"></a><span class="hs-comment">-- i &lt;- 'readVar' hits</span><span>
</span><a name="line-166"></a><span class="hs-comment">-- print (&quot;HITS&quot;,i)</span><span>
</span><a name="line-167"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-168"></a><span class="hs-comment">--</span><span>
</span><a name="line-169"></a><span class="hs-comment">--   Here we have a variable which we modify atomically, so modifications are</span><span>
</span><a name="line-170"></a><span class="hs-comment">--   not interleaved. This use of MVar never blocks on a put. No modifyVar</span><span>
</span><a name="line-171"></a><span class="hs-comment">--   operation should ever block, and they should always complete in a reasonable</span><span>
</span><a name="line-172"></a><span class="hs-comment">--   timeframe. A Var should not be used to protect some external resource, only</span><span>
</span><a name="line-173"></a><span class="hs-comment">--   the variable contained within. Information from a readVar should not be subsequently</span><span>
</span><a name="line-174"></a><span class="hs-comment">--   inserted back into the Var.</span><span>
</span><a name="line-175"></a><span class="hs-keyword">newtype</span><span> </span><a name="Var"><a href="Control.Concurrent.Extra.html#Var"><span class="hs-identifier">Var</span></a></a><span> </span><a name="local-6989586621679058064"><a href="#local-6989586621679058064"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Var"><a href="Control.Concurrent.Extra.html#Var"><span class="hs-identifier">Var</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MVar</span><span> </span><a href="#local-6989586621679058064"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-176"></a><span>
</span><a name="line-177"></a><span class="hs-comment">-- | Create a new 'Var' with a value.</span><span>
</span><a name="line-178"></a><span class="hs-identifier">newVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679058077"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="Control.Concurrent.Extra.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><a href="#local-6989586621679058077"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-179"></a><a name="newVar"><a href="Control.Concurrent.Extra.html#newVar"><span class="hs-identifier">newVar</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="Control.Concurrent.Extra.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">newMVar</span><span>
</span><a name="line-180"></a><span>
</span><a name="line-181"></a><span class="hs-comment">-- | Read the current value of the 'Var'.</span><span>
</span><a name="line-182"></a><span class="hs-identifier">readVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Control.Concurrent.Extra.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><a href="#local-6989586621679058076"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679058076"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-183"></a><a name="readVar"><a href="Control.Concurrent.Extra.html#readVar"><span class="hs-identifier">readVar</span></a></a><span> </span><span class="hs-special">(</span><a href="Control.Concurrent.Extra.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621679058124"><a href="#local-6989586621679058124"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">readMVar</span><span> </span><a href="#local-6989586621679058124"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-184"></a><span>
</span><a name="line-185"></a><span class="hs-comment">-- | Write a value to become the new value of 'Var'.</span><span>
</span><a name="line-186"></a><span class="hs-identifier">writeVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Control.Concurrent.Extra.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><a href="#local-6989586621679058075"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679058075"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-187"></a><a name="writeVar"><a href="Control.Concurrent.Extra.html#writeVar"><span class="hs-identifier">writeVar</span></a></a><span> </span><a name="local-6989586621679058125"><a href="#local-6989586621679058125"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621679058126"><a href="#local-6989586621679058126"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Control.Concurrent.Extra.html#modifyVar_"><span class="hs-identifier hs-var">modifyVar_</span></a><span> </span><a href="#local-6989586621679058125"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679058126"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-188"></a><span>
</span><a name="line-189"></a><span class="hs-comment">-- | Modify a 'Var' producing a new value and a return result.</span><span>
</span><a name="line-190"></a><span class="hs-identifier">modifyVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Control.Concurrent.Extra.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><a href="#local-6989586621679058073"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679058073"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679058073"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679058074"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679058074"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-191"></a><a name="modifyVar"><a href="Control.Concurrent.Extra.html#modifyVar"><span class="hs-identifier">modifyVar</span></a></a><span> </span><span class="hs-special">(</span><a href="Control.Concurrent.Extra.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621679058127"><a href="#local-6989586621679058127"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679058128"><a href="#local-6989586621679058128"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modifyMVar</span><span> </span><a href="#local-6989586621679058127"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621679058128"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span class="hs-comment">-- | Modify a 'Var', a restricted version of 'modifyVar'.</span><span>
</span><a name="line-194"></a><span class="hs-identifier">modifyVar_</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Control.Concurrent.Extra.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><a href="#local-6989586621679058072"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679058072"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679058072"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-195"></a><a name="modifyVar_"><a href="Control.Concurrent.Extra.html#modifyVar_"><span class="hs-identifier">modifyVar_</span></a></a><span> </span><span class="hs-special">(</span><a href="Control.Concurrent.Extra.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621679058129"><a href="#local-6989586621679058129"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679058130"><a href="#local-6989586621679058130"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modifyMVar_</span><span> </span><a href="#local-6989586621679058129"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621679058130"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-196"></a><span>
</span><a name="line-197"></a><span class="hs-comment">-- | Perform some operation using the value in the 'Var',</span><span>
</span><a name="line-198"></a><span class="hs-comment">--   a restricted version of 'modifyVar'.</span><span>
</span><a name="line-199"></a><span class="hs-identifier">withVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Control.Concurrent.Extra.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><a href="#local-6989586621679058070"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679058070"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679058071"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679058071"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-200"></a><a name="withVar"><a href="Control.Concurrent.Extra.html#withVar"><span class="hs-identifier">withVar</span></a></a><span> </span><span class="hs-special">(</span><a href="Control.Concurrent.Extra.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621679058131"><a href="#local-6989586621679058131"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679058132"><a href="#local-6989586621679058132"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withMVar</span><span> </span><a href="#local-6989586621679058131"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621679058132"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span>
</span><a name="line-203"></a><span class="hs-comment">---------------------------------------------------------------------</span><span>
</span><a name="line-204"></a><span class="hs-comment">-- BARRIER</span><span>
</span><a name="line-205"></a><span>
</span><a name="line-206"></a><span class="hs-comment">-- | Starts out empty, then is filled exactly once. As an example:</span><span>
</span><a name="line-207"></a><span class="hs-comment">--</span><span>
</span><a name="line-208"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-209"></a><span class="hs-comment">-- bar &lt;- 'newBarrier'</span><span>
</span><a name="line-210"></a><span class="hs-comment">-- forkIO $ do ...; val &lt;- ...; 'signalBarrier' bar val</span><span>
</span><a name="line-211"></a><span class="hs-comment">-- print =&lt;&lt; 'waitBarrier' bar</span><span>
</span><a name="line-212"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-213"></a><span class="hs-comment">--</span><span>
</span><a name="line-214"></a><span class="hs-comment">--   Here we create a barrier which will contain some computed value.</span><span>
</span><a name="line-215"></a><span class="hs-comment">--   A thread is forked to fill the barrier, while the main thread waits</span><span>
</span><a name="line-216"></a><span class="hs-comment">--   for it to complete. A barrier has similarities to a future or promise</span><span>
</span><a name="line-217"></a><span class="hs-comment">--   from other languages, has been known as an IVar in other Haskell work,</span><span>
</span><a name="line-218"></a><span class="hs-comment">--   and in some ways is like a manually managed thunk.</span><span>
</span><a name="line-219"></a><span class="hs-keyword">newtype</span><span> </span><a name="Barrier"><a href="Control.Concurrent.Extra.html#Barrier"><span class="hs-identifier">Barrier</span></a></a><span> </span><a name="local-6989586621679058011"><a href="#local-6989586621679058011"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Barrier"><a href="Control.Concurrent.Extra.html#Barrier"><span class="hs-identifier">Barrier</span></a></a><span> </span><span class="hs-special">(</span><a href="Control.Concurrent.Extra.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MVar</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679058011"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-220"></a><span>    </span><span class="hs-comment">-- Either a Left empty MVar you should wait or a Right result</span><span>
</span><a name="line-221"></a><span>    </span><span class="hs-comment">-- With base 4.7 and above readMVar is atomic so you probably can implement Barrier directly on MVar a</span><span>
</span><a name="line-222"></a><span>
</span><a name="line-223"></a><span class="hs-comment">-- | Create a new 'Barrier'.</span><span>
</span><a name="line-224"></a><span class="hs-identifier">newBarrier</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="Control.Concurrent.Extra.html#Barrier"><span class="hs-identifier hs-type">Barrier</span></a><span> </span><a href="#local-6989586621679058069"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-225"></a><a name="newBarrier"><a href="Control.Concurrent.Extra.html#newBarrier"><span class="hs-identifier">newBarrier</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="Control.Concurrent.Extra.html#Barrier"><span class="hs-identifier hs-var">Barrier</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Control.Concurrent.Extra.html#newVar"><span class="hs-identifier hs-var">newVar</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><span class="hs-identifier hs-var">newEmptyMVar</span><span>
</span><a name="line-226"></a><span>
</span><a name="line-227"></a><span class="hs-comment">-- | Write a value into the Barrier, releasing anyone at 'waitBarrier'.</span><span>
</span><a name="line-228"></a><span class="hs-comment">--   Any subsequent attempts to signal the 'Barrier' will throw an exception.</span><span>
</span><a name="line-229"></a><span class="hs-identifier">signalBarrier</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Control.Concurrent.Extra.html#Barrier"><span class="hs-identifier hs-type">Barrier</span></a><span> </span><a href="#local-6989586621679058068"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679058068"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-230"></a><a name="signalBarrier"><a href="Control.Concurrent.Extra.html#signalBarrier"><span class="hs-identifier">signalBarrier</span></a></a><span> </span><span class="hs-special">(</span><a href="Control.Concurrent.Extra.html#Barrier"><span class="hs-identifier hs-var">Barrier</span></a><span> </span><a name="local-6989586621679058133"><a href="#local-6989586621679058133"><span class="hs-identifier">var</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679058134"><a href="#local-6989586621679058134"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mask_</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-comment">-- use mask so never in an inconsistent state</span><span>
</span><a name="line-231"></a><span>    </span><span class="hs-identifier hs-var">join</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Control.Concurrent.Extra.html#modifyVar"><span class="hs-identifier hs-var">modifyVar</span></a><span> </span><a href="#local-6989586621679058133"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679058135"><a href="#local-6989586621679058135"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679058135"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-232"></a><span>        </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679058136"><a href="#local-6989586621679058136"><span class="hs-identifier">bar</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621679058134"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">putMVar</span><span> </span><a href="#local-6989586621679058136"><span class="hs-identifier hs-var">bar</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-233"></a><span>        </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679058137"><a href="#local-6989586621679058137"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;Control.Concurrent.Extra.signalBarrier, attempt to signal a barrier that has already been signaled&quot;</span><span>
</span><a name="line-234"></a><span>
</span><a name="line-235"></a><span>
</span><a name="line-236"></a><span class="hs-comment">-- | Wait until a barrier has been signaled with 'signalBarrier'.</span><span>
</span><a name="line-237"></a><span class="hs-identifier">waitBarrier</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Control.Concurrent.Extra.html#Barrier"><span class="hs-identifier hs-type">Barrier</span></a><span> </span><a href="#local-6989586621679058067"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679058067"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-238"></a><a name="waitBarrier"><a href="Control.Concurrent.Extra.html#waitBarrier"><span class="hs-identifier">waitBarrier</span></a></a><span> </span><span class="hs-special">(</span><a href="Control.Concurrent.Extra.html#Barrier"><span class="hs-identifier hs-var">Barrier</span></a><span> </span><a name="local-6989586621679058138"><a href="#local-6989586621679058138"><span class="hs-identifier">var</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-239"></a><span>    </span><a name="local-6989586621679058139"><a href="#local-6989586621679058139"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Control.Concurrent.Extra.html#readVar"><span class="hs-identifier hs-var">readVar</span></a><span> </span><a href="#local-6989586621679058138"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-240"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679058139"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-241"></a><span>        </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679058140"><a href="#local-6989586621679058140"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679058140"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-242"></a><span>        </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679058141"><a href="#local-6989586621679058141"><span class="hs-identifier">bar</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-243"></a><span>            </span><span class="hs-identifier hs-var">readMVar</span><span> </span><a href="#local-6989586621679058141"><span class="hs-identifier hs-var">bar</span></a><span>
</span><a name="line-244"></a><span>            </span><a name="local-6989586621679058142"><a href="#local-6989586621679058142"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Control.Concurrent.Extra.html#readVar"><span class="hs-identifier hs-var">readVar</span></a><span> </span><a href="#local-6989586621679058138"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-245"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679058142"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-246"></a><span>                </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679058143"><a href="#local-6989586621679058143"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679058143"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-247"></a><span>                </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679058144"><a href="#local-6989586621679058144"><span class="hs-identifier">bar</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;Control.Concurrent.Extra, internal invariant violated in Barrier&quot;</span><span>
</span><a name="line-248"></a><span>
</span><a name="line-249"></a><span>
</span><a name="line-250"></a><span class="hs-comment">-- | A version of 'waitBarrier' that never blocks, returning 'Nothing'</span><span>
</span><a name="line-251"></a><span class="hs-comment">--   if the barrier has not yet been signaled.</span><span>
</span><a name="line-252"></a><span class="hs-identifier">waitBarrierMaybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Control.Concurrent.Extra.html#Barrier"><span class="hs-identifier hs-type">Barrier</span></a><span> </span><a href="#local-6989586621679058066"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679058066"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-253"></a><a name="waitBarrierMaybe"><a href="Control.Concurrent.Extra.html#waitBarrierMaybe"><span class="hs-identifier">waitBarrierMaybe</span></a></a><span> </span><span class="hs-special">(</span><a href="Control.Concurrent.Extra.html#Barrier"><span class="hs-identifier hs-var">Barrier</span></a><span> </span><a name="local-6989586621679058145"><a href="#local-6989586621679058145"><span class="hs-identifier">bar</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Either.Extra.html#eitherToMaybe"><span class="hs-identifier hs-var">eitherToMaybe</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Control.Concurrent.Extra.html#readVar"><span class="hs-identifier hs-var">readVar</span></a><span> </span><a href="#local-6989586621679058145"><span class="hs-identifier hs-var">bar</span></a><span>
</span><a name="line-254"></a></pre></body></html>